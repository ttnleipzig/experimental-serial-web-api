<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Web Serial Example</title>
    <meta name="description" content="Web Serial Example to play with Web Serial API">
    <meta name="author" content="André Lademann">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23ffffff%22 width=%2224%22 height=%2224%22><path d=%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z%22/%3E</svg>">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="">

    <main class="flex flex-col justify-center h-screen max-w-screen-lg px-4 mx-auto text-slate-700">
        <h1 class="text-4xl font-bold">Web Serial Example</h1>
        <p>
            This is an example of how to use the Web Serial API to connect to a serial device. This example will
            connect to a serial device at 115200 baud and print out all data that is received.
        </p>
        <div class="p-4 my-3 rounded bg-sky-100 text-sky-800">
            <strong>Note:</strong>
            This example is only supported in Chrome and works with a serial device that is
            connected to your computer.
        </div>

        <h2 class="text-2xl">Scenarios</h2>

        <h3 class="mt-3 text-xl">Connect via bluetooth</h3>
        <p>
            To connect via bluetooth, you need to have a bluetooth device connected to your computer.
            After that, you can click the button below to connect to the serial device.
            The serial device will be connected to your computer and you can start sending data to it.
            You can also see the data that is received from the serial device.
            The serial device must be set to 115200 baud.
            You can change the baud rate in the code.
        </p>

        <h3 class="mt-3 text-xl">
            Connect via USB
        </h3>
        <p>
            To connect via USB, you need to have a USB device connected to your computer.
            After that, you can click the button below to connect to the serial device.
            The serial device will be connected to your computer and you can start sending data to it.
            You can also see the data that is received from the serial device.
            The serial device must be set to 115200 baud.
            You can change the baud rate in the code.
        </p>
        <div class="flex flex-col p-6 my-3 border border-dashed bg-slate-100 border-slate-300">
            <button id="connect"
                class="p-3 mb-3 bg-blue-200 border rounded hover:border-slate-300 hover:bg-slate-200 active:bg-slate-300">Connect</button>
            <label for="log" class="text-align-left">Log:</label>
            <textarea id="log" readonly placeholder="Log output"
                class="w-full p-3 border rounded text-slate-500"></textarea>
        </div>
    </main>
    <script>
        document.getElementById('connect').addEventListener('click', async () => {
            // Prüfen, ob der Browser Web Serial unterstützt
            if ('serial' in navigator) {
                try {
                    const port = await navigator.serial.requestPort() // Benutzer fragen, welchen Port er öffnen möchte
                    await port.open({baudRate: 115200}) // Port mit Baudrate öffnen

                    const writer = port.writable.getWriter()
                    const textEncoder = new TextEncoderStream()
                    const writableStreamClosed = textEncoder.readable.pipeTo(port.writable)

                    const reader = port.readable.getReader()

                    document.getElementById('log').textContent += 'Connected …\n'

                    while (true) { // Endlosschleife zum Lesen von Daten
                        const {value, done} = await reader.read() // Lese Daten vom Gerät

                        if (done) {
                            reader.releaseLock()
                            break
                        }

                        document.getElementById('log').textContent += new TextDecoder().decode(value)
                    }
                } catch (e) {
                    console.error(e)
                    document.getElementById('log').textContent += e.message + '\n'
                }
            } else {
                console.log('Your browser does not support the Web Serial API.')
            }
        });
    </script>

</body>

</html>
